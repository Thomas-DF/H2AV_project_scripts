library(GenomicRanges)
library(rtracklayer)
library(ggplot2)
library(dplyr)
library(seqplots)
workdir = "~/Bureau/tdefreitas_genobioinfo/PROJET_H2AV_2025/"
source(paste0(workdir, "functionR/AVG_PROFILE.R"))
tmp <- paste0(workdir,"FIGURES/AVG_PROF/TMPgetPlotSetArray")
r6_ref_genes = readRDS(paste0(workdir,"DATA/r6.13/TxDb.GR.dm6.RDS"))
pol2_nelf = import(paste0(workdir,"DATA/macs2/pol2_nelf_summits.bed"))
pol2_ctrl = import(paste0(workdir,"DATA/macs2/pol2_ctrl_summits.bed"))
pol2_nelf = resize(pol2_nelf, fix="start", 50)
pol2_nelf= resize(pol2_nelf, fix="end", 100)
pol2_ctrl = resize(pol2_ctrl, fix="start", 50)
pol2_ctrl= resize(pol2_ctrl, fix="end", 100)
overlaps = findOverlaps(pol2_ctrl, pol2_nelf)
common_peaks = pol2_ctrl[queryHits(overlaps)]
luc_only = pol2_ctrl[!pol2_ctrl %in% common_peaks]
nelf_only = pol2_nelf[!pol2_nelf %in% common_peaks]
seqlevels(common_peaks) = paste0("chr", seqlevels(common_peaks))
seqlevels(luc_only) = paste0("chr", seqlevels(luc_only))
seqlevels(nelf_only) = paste0("chr", seqlevels(nelf_only))
r6_ref_genes = readRDS(paste0(workdir,"DATA/r6.13/TxDb.GR.dm6.RDS"))
r6_ref_genes_GB = r6_ref_genes [width(r6_ref_genes)>500]
starrseq_ENHANCER = readRDS(paste0(workdir,"DATA/r6.13/starrseq_ENHANCER_zabidi.RDS"))
seqlevels(starrseq_ENHANCER) = paste0("chr", seqlevels(starrseq_ENHANCER))
r6_ref_genes_PROM = promoters(r6_ref_genes, upstream=250, downstream=0 )
r6_ref_genes_TES = terminators(r6_ref_genes, upstream=0, downstream=250 )
r6_ref_genes_ALL = c(r6_ref_genes_GB,starrseq_ENHANCER,r6_ref_genes_PROM,r6_ref_genes_TES)
luc_only_GB = luc_only[queryHits(findOverlaps(luc_only, r6_ref_genes_GB))]
luc_only_Other = luc_only[-queryHits(findOverlaps(luc_only, r6_ref_genes_ALL))]
nelf_only_GB = nelf_only[queryHits(findOverlaps(nelf_only, r6_ref_genes_GB))]
nelf_only_Other = nelf_only[-queryHits(findOverlaps(nelf_only, r6_ref_genes_ALL))]
#####################################################################################-
#         SAVE GROUP SELECTION  ----
#####################################################################################-
chromosomes_to_keep <- c("chr2L", "chr2R", "chr3L", "chr3R", "chr4", "chrX", "chrY")
luc_only_GB = luc_only_GB[seqnames(luc_only_GB) %in% chromosomes_to_keep]
luc_only_Other = luc_only_Other[seqnames(luc_only_Other) %in% chromosomes_to_keep]
nelf_only_GB = nelf_only_GB[seqnames(nelf_only_GB) %in% chromosomes_to_keep]
nelf_only_Other = nelf_only_Other[seqnames(nelf_only_Other) %in% chromosomes_to_keep]
seqlevels(luc_only_GB) <- chromosomes_to_keep
seqlevels(luc_only_Other) <- chromosomes_to_keep
seqlevels(nelf_only_GB) <- chromosomes_to_keep
seqlevels(nelf_only_Other) <- chromosomes_to_keep
# Remove overlapping sequences
ol <- findOverlaps(luc_only_GB)
ol <- ol[queryHits(ol) != subjectHits(ol)]
to_remove <- subjectHits(ol)
luc_only_GB <- luc_only_GB[-unique(to_remove)]
ol <- findOverlaps(nelf_only_GB)
ol <- ol[queryHits(ol) != subjectHits(ol)]
to_remove <- subjectHits(ol)
nelf_only_GB <- nelf_only_GB[-unique(to_remove)]
# Saving
seqlengths(luc_only_GB) <- c(chr2L=23513712, chr2R = 25286936, chr3L = 28110227, chr3R =32079331, chr4 = 1348131, chrX=23542271, chrY=3667352)
export(luc_only_GB, paste0(workdir,"DATA/macs2/luc_only_GB.bw"), format = "BigWig")
seqlengths(luc_only_Other) <- c(chr2L=23513712, chr2R = 25286936, chr3L = 28110227, chr3R =32079331, chr4 = 1348131, chrX=23542271, chrY=3667352)
export(luc_only_Other, paste0(workdir,"DATA/macs2/luc_only_Other.bw"), format = "BigWig")
seqlengths(nelf_only_GB) <- c(chr2L=23513712, chr2R = 25286936, chr3L = 28110227, chr3R =32079331, chr4 = 1348131, chrX=23542271, chrY=3667352)
export(nelf_only_GB, paste0(workdir,"DATA/macs2/nelf_only_GB.bw"), format = "BigWig")
seqlengths(nelf_only_Other) <- c(chr2L=23513712, chr2R = 25286936, chr3L = 28110227, chr3R =32079331, chr4 = 1348131, chrX=23542271, chrY=3667352)
export(nelf_only_Other, paste0(workdir,"DATA/macs2/nelf_only_Other.bw"), format = "BigWig")
luc_only_GB_file = paste0(workdir,"DATA/macs2/luc_only_GB.bw")
luc_only_Other_file = paste0(workdir,"DATA/macs2/luc_only_Other.bw")
nelf_only_GB_file = paste0(workdir,"DATA/macs2/nelf_only_GB.bw")
nelf_only_Other_file = paste0(workdir,"DATA/macs2/nelf_only_Other.bw")
LIST_QUANTIF_K36=readRDS(paste0(workdir,"DATA/LIST_FEATURES/LIST_QUANTIF_K36.RDS"))
ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f=LIST_QUANTIF_K36$ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f
getNameList = function(Vec, topdown = "top", prct = 10){
Vec = Vec[order(Vec, decreasing=T)]
if(topdown %in% "top"){
GN = names(Vec[Vec > quantile(Vec, (100-prct)/100)])
}
if(topdown %in% "down"){
GN = names(Vec[Vec < quantile(Vec, (prct)/100)])
}
if(topdown %in% "mid"){
tmp1 = names(Vec[Vec < quantile(Vec, (100/2-prct/2)/100)])
tmp2 = names(Vec[Vec < quantile(Vec, (100/2-prct/2+prct)/100)])
GN = tmp2[tmp2 %ni% tmp1]
}
return(GN)
}
len = length(ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f)
UP_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = getNameList(ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f, topdown = "top", prct = 5)
UP_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = getNameList(ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f, topdown = "top", prct = 1)
CTRL_60_65_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = names(ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f[(len*0.6) : (len*0.65)])
DN_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = getNameList(ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f, topdown = "down", prct = 5)
DN_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = getNameList(ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f, topdown = "down", prct = 1)
## GET GRANGES COORDS OF FEATURES TO PLOT AROUND
get_GR_feat = function(refGN, GNlist){
myovlp=refGN[refGN$name %in% GNlist]
return(myovlp)
}
GR_UP_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = get_GR_feat(r6_ref_genes,UP_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f)
GR_UP_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = get_GR_feat(r6_ref_genes,UP_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f)
GR_CTRL_60_65_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = get_GR_feat(r6_ref_genes,CTRL_60_65_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f)
GR_DN_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f = get_GR_feat(r6_ref_genes,DN_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f)
GR_DN_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f= get_GR_feat(r6_ref_genes,DN_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f)
GR_list_toPlot = c("GR_UP_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f", "GR_UP_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f", "GR_CTRL_60_65_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f", "GR_DN_5_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f", "GR_DN_1_ZSCORE_H3K36me3_2C4_H3K36me3_2N4_f")
pdf(paste0(workdir,"FIGURES/AVG_PROF/POL2_PEAKS/AVG_RNA_POL2_PEAKS_LUC_ONLY_GB_OTHER.pdf"))
for(GR in GR_list_toPlot){
seqPlotSDoutliers_scaleFact(c(luc_only_GB_file, luc_only_Other_file),tmp,GR,c(0,50),c(5000,5000),type="af",bin=10,
smooth=FALSE,spar=0.3, scalingF = c(1,1), sd=c(T,3), gnme=NA, colvec = c("#594d32", "#e09d00"))
}
dev.off()
pdf(paste0(workdir,"FIGURES/AVG_PROF/POL2_PEAKS/AVG_RNA_POL2_PEAKS_NELF_ONLY_GB_OTHER.pdf"))
for(GR in GR_list_toPlot){
seqPlotSDoutliers_scaleFact(c(nelf_only_GB_file, nelf_only_Other_file),tmp,GR,c(0,50),c(5000,5000),type="af",bin=10,
smooth=FALSE,spar=0.3, scalingF = c(1,1), sd=c(T,3), gnme=NA, colvec = c("#594d32", "#e09d00"))
}
dev.off()
